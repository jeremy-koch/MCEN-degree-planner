<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCEN Planner</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --cu-gold: #CFB87C; }
        .btn-cu { background-color: var(--cu-gold); color: black; font-weight: 800; }
        .btn-cu:hover { background-color: #bfa86b; }
        .progress-fill { background-color: var(--cu-gold); transition: width 0.5s ease; }
        .summer-row { display: none; }
        .summer-row.show { display: block; }
        
        /* Hover Tooltip */
        .course-chip { position: relative; cursor: help; }
        .course-chip:hover::after {
            content: attr(data-title);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: #1a1a1a; color: white; padding: 6px 12px; border-radius: 4px;
            white-space: nowrap; font-size: 11px; z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .notes-area { display: none; }
        .notes-area.show { display: block; }

        @media print { .no-print { display: none !important; } .notes-input { border: none; resize: none; } }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 text-gray-900">
    <div class="max-w-3xl mx-auto">
        
        <header class="bg-black text-white p-6 rounded-t-2xl border-b-4 border-[#CFB87C]">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-black italic">MCEN <span class="text-[#CFB87C]">PLANNER</span></h1>
                <div class="text-right">
                    <div id="grand-total" class="text-3xl font-mono font-bold text-[#CFB87C]">0</div>
                    <div class="text-[9px] uppercase font-bold text-gray-400">Total Credits</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                    <span>Degree Progress</span>
                    <span id="prog-txt">0%</span>
                </div>
                <div class="w-full bg-gray-800 h-2 rounded-full"><div id="prog-bar" class="progress-fill h-full rounded-full" style="width: 0%"></div></div>
            </div>
        </header>

        <div class="bg-white border-x border-b p-3 flex gap-2 no-print justify-between">
            <div class="flex gap-2">
                <button onclick="window.print()" class="text-[10px] font-bold px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">PRINT PDF</button>
                <button id="tog-trans" class="text-[10px] font-bold px-3 py-1 bg-gray-100 rounded uppercase">+ Transfer Credits</button>
            </div>
            <button onclick="clearStorage()" class="text-[10px] font-bold px-3 py-1 text-red-600 bg-red-50 rounded hover:bg-red-100">RESET ALL</button>
        </div>

        <div id="sec-trans" class="hidden bg-amber-50 p-4 border-x border-b border-dashed border-gray-300">
            <div class="flex gap-2">
                <input id="in-transfer" class="border p-2 text-xs rounded flex-1 font-mono enter-listener" data-sid="transfer" placeholder="Ex: APPM 1350">
                <button onclick="pyAdd('transfer')" class="btn-cu px-4 py-2 rounded text-xs">ADD</button>
            </div>
            <ul id="list-transfer" class="mt-3 space-y-1"></ul>
        </div>

        <div class="bg-white p-4 border-x border-b shadow-sm mb-6">
            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Missing Core (Hover for Info):</h3>
            <div id="req-bank" class="flex flex-wrap gap-1"></div>
        </div>

        <div id="main-container" class="space-y-8"></div>

        <div class="mt-8 flex justify-center pb-20 no-print">
            <button id="btn-year" class="btn-cu px-8 py-3 rounded-xl shadow-lg">+ ADD ANOTHER YEAR</button>
        </div>
    </div>

    <script>
        // JS Bridge
        function pyAdd(sid) {
            const val = document.getElementById('in-' + sid).value;
            if (window.py_add_course) window.py_add_course(sid, val);
        }
        function pyRem(sid, idx) {
            if (window.py_rem_course) window.py_rem_course(sid, idx);
        }
        function toggleSummer(cleanName, btn) {
            const el = document.getElementById('row-' + cleanName + '-Summer');
            el.classList.toggle('show');
            btn.innerText = el.classList.contains('show') ? '- HIDE SUMMER' : '+ ADD SUMMER';
        }
        function toggleNotes(cleanName, btn) {
            const el = document.getElementById('notes-' + cleanName);
            el.classList.toggle('show');
            btn.innerText = el.classList.contains('show') ? '- HIDE NOTES' : '+ ADD NOTES/GOALS';
        }
        function clearStorage() {
            if(confirm("Are you sure? This will delete your entire saved plan.")) {
                localStorage.removeItem('mcen_planner_data');
                location.reload();
            }
        }
        function pyUpdateNotes(name, val) {
            if (window.py_save_notes) window.py_save_notes(name, val);
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.classList.contains('enter-listener')) {
                pyAdd(e.target.getAttribute('data-sid'));
            }
        });
    </script>

    <script type="py">
        from pyscript import document, window
        from pyodide.ffi import create_proxy
        import json

        CATALOG = { 
            "APPM 1350": {"t": "Calculus 1", "c": 4}, "MCEN 1030": {"t": "Engineering Comp", "c": 4}, 
            "PHYS 1110": {"t": "Physics 1", "c": 4}, "GEEN 1400": {"t": "Engr Projects", "c": 3}, 
            "COEN 1500": {"t": "Seminar", "c": 1}, "APPM 1360": {"t": "Calculus 2", "c": 4}, 
            "MCEN 1024": {"t": "Chemistry", "c": 3}, "MCEN 1025": {"t": "CAD/Fab", "c": 4}, 
            "PHYS 1120": {"t": "Physics 2", "c": 4}, "PHYS 1140": {"t": "Exp Physics 1", "c": 1}, 
            "APPM 2350": {"t": "Calculus 3", "c": 4}, "MCEN 2000": {"t": "ME Profession", "c": 1}, 
            "MCEN 2023": {"t": "Statics", "c": 3}, "MCEN 2024": {"t": "Materials Sci", "c": 3}, 
            "APPM 2360": {"t": "Diff Eq", "c": 4}, "MCEN 2043": {"t": "Dynamics", "c": 3}, 
            "MCEN 2063": {"t": "Solids", "c": 3}, "MCEN 3012": {"t": "Thermodynamics", "c": 3}, 
            "MCEN 3017": {"t": "Circuits", "c": 3}, "MCEN 3021": {"t": "Fluid Mechanics", "c": 3}, 
            "MCEN 3025": {"t": "Component Design", "c": 3}, "MCEN 3030": {"t": "Computational Methods", "c": 3}, 
            "MCEN 3022": {"t": "Heat Transfer", "c": 3}, "MCEN 4026": {"t": "Manufacturing Processes", "c": 3}, 
            "MCEN 4043": {"t": "System Dynamics", "c": 3}, "MCEN 3032": {"t": "Thermodynamics 2", "c": 3}, 
            "MCEN 3047": {"t": "Data Analysis & Exp Methods", "c": 4}, "MCEN 4045": {"t": "ME Design Project 1", "c": 3}, 
            "MCEN 4085": {"t": "ME Senior Design 2", "c": 3},
            "WRITING REQUIREMENT": {"t": "Upper Div Writing", "c": 3},
            "FREE ELECTIVE 1": {"t": "Free Elective", "c": 3}
        }
        
        # Default State
        planner = {"transfer": []}
        sems = ["transfer"]
        notes = {}
        year_list = ["First Year", "Sophomore Year", "Junior Year", "Senior Year"]

        def save_to_local():
            data = {"planner": planner, "sems": sems, "notes": notes, "year_list": year_list}
            window.localStorage.setItem('mcen_planner_data', json.dumps(data))

        def load_from_local():
            global planner, sems, notes, year_list
            raw = window.localStorage.getItem('mcen_planner_data')
            if raw:
                data = json.loads(raw)
                planner = data.get("planner", planner)
                sems = data.get("sems", sems)
                notes = data.get("notes", notes)
                year_list = data.get("year_list", year_list)

        def refresh():
            grand_total, core_count = 0, 0
            planned_norm = [c['code'].replace(" ","").upper() for s in sems for c in planner[s]]
            
            bank = document.getElementById("req-bank")
            bank.innerHTML = ""
            for code, data in CATALOG.items():
                if code.replace(" ","").upper() not in planned_norm:
                    span = document.createElement("span")
                    span.className = "course-chip text-[9px] bg-gray-50 border px-1.5 py-0.5 rounded text-gray-400 font-mono"
                    span.innerText = code
                    span.setAttribute("data-title", f"{data['t']} ({data['c']} hrs)")
                    bank.appendChild(span)
                else: core_count += 1
            
            perc = int((core_count/len(CATALOG))*100)
            document.getElementById("prog-bar").style.width = f"{perc}%"
            document.getElementById("prog-txt").innerText = f"{perc}%"

            for sid in sems:
                el = document.getElementById(f"list-{sid}")
                if not el: continue
                el.innerHTML = ""
                sub = 0
                for i, c in enumerate(planner[sid]):
                    sub += c['credits']
                    li = document.createElement("li")
                    li.className = "flex justify-between items-center bg-white p-2 rounded border text-xs font-mono shadow-sm"
                    li.innerHTML = f"<span><b>{c['code']}</b></span><button onclick='pyRem(\"{sid}\", {i})' class='text-red-500 font-bold'>[X]</button>"
                    el.appendChild(li)
                grand_total += sub
                if document.getElementById(f"sub-{sid}"): document.getElementById(f"sub-{sid}").innerText = str(sub)
            
            document.getElementById("grand-total").innerText = str(grand_total)
            save_to_local()

        def add_course(sid, val):
            val = val.strip().upper()
            match = val if val in CATALOG else (val if " " in val else f"{val[:4]} {val[4:]}")
            if match in CATALOG:
                planner[sid].append({"code": match, "credits": CATALOG[match]['c']})
                document.getElementById(f"in-{sid}").value = ""
                refresh()

        def rem_course(sid, idx):
            planner[sid].pop(int(idx))
            refresh()

        def save_notes(name, val):
            notes[name] = val
            save_to_local()

        window.py_add_course = create_proxy(add_course)
        window.py_rem_course = create_proxy(rem_course)
        window.py_save_notes = create_proxy(save_notes)

        def build_year(name):
            cont = document.getElementById("main-container")
            y_div = document.createElement("div")
            clean = name.replace(" ", "")
            
            note_content = notes.get(name, "")
            html = f"""
            <div class='mb-2 flex justify-between items-end border-b-4 border-black pb-1'>
                <h3 class='text-xl font-black italic uppercase tracking-tighter'>{name}</h3>
                <div class='flex gap-4 no-print'>
                    <button onclick='toggleNotes("{clean}", this)' class='text-[10px] font-bold text-gray-500 hover:underline'>+ ADD NOTES/GOALS</button>
                    <button onclick='toggleSummer("{clean}", this)' class='text-[10px] font-bold text-amber-600 hover:underline'>+ ADD SUMMER</button>
                </div>
            </div>
            <div id='notes-{clean}' class='notes-area mb-4 {"show" if note_content else ""}'>
                <textarea oninput='pyUpdateNotes("{name}", this.value)' class='w-full p-3 text-xs border rounded-lg bg-gray-50 focus:bg-white outline-none notes-input' rows='2' placeholder='Yearly goals, internship deadlines, or project ideas...'>{note_content}</textarea>
            </div>
            <div class='flex flex-col gap-4'>"""
            
            for t in ["Fall", "Spring", "Summer"]:
                sid = f"{clean}-{t}"
                if sid not in sems: sems.append(sid)
                if sid not in planner: planner[sid] = []
                is_sum = "summer-row" if t == "Summer" and not planner[sid] else ("summer-row show" if t == "Summer" else "")
                html += f"""
                <div id='row-{sid}' class='bg-white p-4 rounded-lg border shadow-sm {is_sum}'>
                    <div class='flex justify-between items-center mb-3'>
                        <span class='font-black text-sm uppercase tracking-widest'>{t}</span>
                        <span class='text-[10px] font-bold bg-gray-100 px-2 py-0.5 rounded'>HRS: <span id='sub-{sid}'>0</span></span>
                    </div>
                    <div class='flex gap-1 mb-3 no-print'>
                        <input id='in-{sid}' class='border p-2 text-xs rounded flex-1 font-mono enter-listener' data-sid='{sid}' placeholder='Code'>
                        <button onclick='pyAdd("{sid}")' class='btn-cu px-4 py-1 rounded text-[10px]'>ADD</button>
                    </div>
                    <ul id='list-{sid}' class='space-y-1'></ul>
                </div>"""
            html += "</div>"
            y_div.innerHTML = html
            cont.appendChild(y_div)

        # Startup Logic
        load_from_local()
        for year in year_list:
            build_year(year)

        def add_year_handler(e):
            new_name = f"Year {len(year_list)+1}"
            year_list.append(new_name)
            build_year(new_name)
            save_to_local()
        
        document.getElementById("btn-year").onclick = create_proxy(add_year_handler)
        document.getElementById("tog-trans").onclick = create_proxy(lambda e: document.getElementById("sec-trans").classList.toggle("hidden"))
        refresh()
    </script>
</body>
</html>